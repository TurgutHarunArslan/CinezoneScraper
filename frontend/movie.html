<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video</title>
    <link rel="stylesheet" href="global.css">
</head>
<body>
    <nav class="topnav">
        <a href="/">Home</a>
    </nav>
    <div id="container">
        <div id="player">
            <iframe src="" frameborder="0" id="video" allowfullscreen></iframe>
        </div>
        <div class="episode-list"></div>
    </div>
</body>
    </html>

<script>
    let dev = false
    let BaseUrl = ""
    let MovieData
    let currentPartId = ""
    if (dev == true){
        BaseUrl = "http://0.0.0.0:3000/"
    }else{
        BaseUrl = "https://spreading-club-municipal-saver.trycloudflare.com/"
    }
    const container = document.querySelector(".episode-list")
    const video = document.querySelector("#video")
    const player = document.querySelector("#player")
    function getTrackIdFromQuery() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('TrackId');
    }
    function setPart(id){
        let active_part = document.querySelector("#active-part")
        let new_part = document.querySelector(`[data-id='${id}']`)
        if (active_part != null){
            active_part.id = ""
        }
        ApiCall("episode","?id=" + id,false).then((data)=>{
            currentPartId = id
            localStorage.setItem(getTrackIdFromQuery(),id)
            video.setAttribute("src",data)
            if (new_part != null){
                new_part.id = "active-part"
            }
            
        })
    }
    function getNextEpisode(currentId) {
        const epList = MovieData["EpList"];
        const currentIndex = epList.findIndex(ep => ep.Id === currentId);
        return (currentIndex !== -1 && currentIndex < epList.length - 1) ? epList[currentIndex + 1] : null;
    }

    const getPreviousEpisode = (currentId) => {
        const episodes = MovieData["EpList"];
        const index = episodes.findIndex(ep => ep.Id === currentId);
        return index > 0 ? episodes[index - 1] : null;
    };

    container.addEventListener("click",function(event){
        if (event.target.tagName == "BUTTON"){
            let id = event.target.getAttribute("data-id")
            setPart(id)
        }
    })
    function createEpisodeListDOM(data) {
        data["EpList"].forEach(episode => {
            const Item = document.createElement('button');
            Item.textContent = `Season ${episode.Season}, Episode ${episode.EpNumber}`;
            Item.setAttribute("data-id",episode.Id)
            container.appendChild(Item);
        });
    }

    async function ApiCall(endpoint,query,json) {
        let r = await fetch(BaseUrl + endpoint + query)
        if (json){
            return await r.json()
        }
        return await r.text()
    }

    function NextEpisode() {
        let ep = getNextEpisode(currentPartId)
        if (ep != null){
            setPart(ep.Id)
        }
    }

    function PrevEpisode() {
        let ep = getPreviousEpisode(currentPartId)
        if (ep != null){
            setPart(ep.Id)
        }
    }

    function Load(){
        let buttons = `
        <div id="controllers">
                <button onclick="PrevEpisode()">Previous Episode</button>
                <button onclick="NextEpisode()">Next Episode</button>
        </div>
        `
        if(getTrackIdFromQuery() == null){
            const baseUrl = window.location.origin;
            const newUrl = new URL('/', baseUrl);
            window.location.href = newUrl.toString()
        }
        ApiCall("movie","?TrackId=" + getTrackIdFromQuery(),true).then((data) => {
            MovieData = data
            if (data.EpList.length > 1) {
                player.insertAdjacentHTML('beforeend', buttons);
                createEpisodeListDOM(data)
            }
            if (localStorage.getItem(getTrackIdFromQuery()) == null ) {
                let partId = data.EpList[0]["Id"]
                setPart(partId)
                localStorage.setItem(getTrackIdFromQuery(),partId)
            }else{
                setPart(localStorage.getItem(getTrackIdFromQuery()))
            }
        })
    }

    Load()
</script>

<style>
    #container{
        width: 100%;
        height: 100%;
        display: flex;
        align-items: flex-start; 
        padding: 20px;
        gap: 20px; 
    }
    .episode-list{
        flex: 1;
        width: fit-content;
        height: fit-content;
    }

    #player{
        width: 60%;
        height: 60%;
        flex: 2;
    }
    #video{
        width: 100%;
        height: 100%;
    }
    #active-part{
        background-color: blue;
    }
</style>
